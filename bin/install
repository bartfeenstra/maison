#!/usr/bin/env bash

set -Eeuo pipefail

cd "$(dirname "$0")/.."

. ./src/bash/maintenance

if [ -f ./data/.krab/installed_version ]; then
    ./vendor/krab/bin/krab stdio-alert 'Maison has been installed already. Did you mean ./bin/upgrade?'
    exit 2
fi

if [ ! -f ./.env ]; then
    ./bin/build
fi
. .env

# Oathkeeper.
install_app_db "$MAISON_AC_DB_NAME" "$MAISON_AC_DB_USERNAME" "$MAISON_AC_DB_PASSWORD"
docker run -it --rm  --network maison_maison oryd/oathkeeper:v1.0.0-beta.8 migrate sql "mysql://${MAISON_AC_DB_USERNAME}:${MAISON_AC_DB_PASSWORD}@tcp(db:3306)/${MAISON_AC_DB_NAME}"

# openHAB.
install_app_db "$MAISON_HAB_DB_NAME" "$MAISON_HAB_DB_USERNAME" "$MAISON_HAB_DB_PASSWORD"

# Gitea.
install_app_db "$MAISON_VCS_DB_NAME" "$MAISON_VCS_DB_USERNAME" "$MAISON_VCS_DB_PASSWORD"
install_vcs_user "$MAISON_VCS_ADMIN_USERNAME" "$MAISON_VCS_ADMIN_PASSWORD" "$MAISON_VCS_ADMIN_EMAIL" --admin

# Drone.
install_app_db "$MAISON_CI_DB_NAME" "$MAISON_CI_DB_USERNAME" "$MAISON_CI_DB_PASSWORD"
install_vcs_user "$MAISON_CI_GITEA_USERNAME" "$MAISON_CI_GITEA_PASSWORD" "$MAISON_CI_GITEA_EMAIL" --admin

# Persist the currently installed version.
./vendor/krab/bin/krab migrate-install ./data/.krab ./migrations
