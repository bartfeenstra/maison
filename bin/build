#!/usr/bin/env bash

set -Eeuo pipefail

cd "$(dirname "$0")/.."

ensure_env_mode() {
    chmod u=rw,go= .env
}

if [ ! -f ./.env ]; then
    ./bin/generate-env-passwords .env.dist > .env
    ensure_env_mode
    echo "A new configuration file with random passwords has been saved to $(readlink -f ./.env). Fill in the remaining settings, and run this command (./bin/build) again to finish the build."
    exit 1
fi
ensure_env_mode
mkdir -p ./data/services/db
mkdir -p ./data/services/network
mkdir -p ./data/services/web
mkdir -p ./data/services/web/letsencrypt
sudo chown -R :docker ./data/services/*
sudo chmod -R ug+rwx ./data/services/*
touch ./data/services/web/htpasswd
docker run --entrypoint /bin/cat bartfeenstra/ola:0.1 /etc/udev/rules.d/ftdi.rules | sudo tee -a /etc/udev/rules.d/ftdi.rules

sudo groupadd -f -g 9001 openhab
id -u openhab &>/dev/null || sudo useradd -u 9001 -g openhab -r -s /sbin/nologin openhab && sudo usermod -a -G openhab "$(whoami)"

mkdir -p ./vendor/bin

# Set up wait-for-it.
if [ ! -f ./vendor/bin/wait-for-it ]; then
    curl https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh > ./vendor/bin/wait-for-it
fi
# Set up shUnit2.
if [[ ! -d ./vendor/shunit2 ]]; then
    git clone https://github.com/kward/shunit2.git ./vendor/shunit2
fi

chmod ugo+rx ./vendor/bin/*

docker-compose -p maison build "$@"

echo "SUCCESS: ALL BUILD STEPS PASSED."
