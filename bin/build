#!/usr/bin/env bash

cd `dirname "$0"`/..

# Aggregate build step exit codes.
exit_code=0
trap '(( exit_code |= $? ))' ERR

mkdir -p ./db/data
touch ./nginx/htpasswd
sudo cp ./ola/ftdi.rules /etc/udev/rules.d/

sudo groupadd -f -g 9001 openhab
id -u openhab &>/dev/null || sudo useradd -u 9001 -g openhab -r -s /sbin/nologin openhab && sudo usermod -a -G openhab `whoami`

docker-compose -p maison build $@

# Stop aggregating build step exit codes.
trap - ERR

if [ $exit_code -eq 0 ]
then
    echo "SUCCESS: ALL BUILD STEPS PASSED."
else
    echo "ERROR: SOME BUILD STEPS FAILED."
fi
exit $exit_code
