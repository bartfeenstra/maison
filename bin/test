#!/usr/bin/env bash

set -e

cd `dirname "$0"`/..

function message {
    message=$1
    echo ""
    echo $message
    echo ""
}

# Prepare the test environment.
set -a
. .env
username=maisontest
password=bienvenue
set +a
htpasswd -b ./services/web/data/htpasswd $username $password

# Aggregate test results.
total=0
failures=0
for test in ./tests/*; do
    total=$((total + 1))
    message "Running test $test..."
    set +e
    $test && message "TEST $test PASSED" || { failures=$((failures + 1)) && message "TEST $test FAILED"; }
    set -e
done

htpasswd -D ./services/web/data/htpasswd $username

if [ $failures -eq 0 ]
then
    message "SUCCESS: $total TEST(S) PASSED."
    exit
else
    message "ERROR: $failures OUT OF $total TEST(S) FAILED."
    exit 1
fi
