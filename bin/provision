#!/usr/bin/env bash

cd `dirname "$0"`/..

# Exit on errors.
trap 'exit $?' ERR

if [ ! -f ./.env ]; then
    ./bin/build
    exit 1
fi
. .env

### Databases.
# openHAB.
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS ${MAISON_HAB_DB_NAME};"
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "CREATE USER IF NOT EXISTS '${MAISON_HAB_DB_USERNAME}'@'%' IDENTIFIED BY '${MAISON_HAB_DB_PASSWORD}';"
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "GRANT ALL PRIVILEGES ON ${MAISON_HAB_DB_NAME}.* TO '${MAISON_HAB_DB_USERNAME}'@'%';"
docker exec maison_db_1 mysql -u ${MAISON_HAB_DB_USERNAME} -p${MAISON_HAB_DB_PASSWORD} -D ${MAISON_HAB_DB_NAME} -e ""
# Gitea.
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS ${MAISON_VCS_DB_NAME};"
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "CREATE USER IF NOT EXISTS '${MAISON_VCS_DB_USERNAME}'@'%' IDENTIFIED BY '${MAISON_VCS_DB_PASSWORD}';"
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "GRANT ALL PRIVILEGES ON ${MAISON_VCS_DB_NAME}.* TO '${MAISON_VCS_DB_USERNAME}'@'%';"
docker exec maison_db_1 mysql -u ${MAISON_VCS_DB_USERNAME} -p${MAISON_VCS_DB_PASSWORD} -D ${MAISON_VCS_DB_NAME} -e ""
# Drone.
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS ${MAISON_CI_DB_NAME};"
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "CREATE USER IF NOT EXISTS '${MAISON_CI_DB_USERNAME}'@'%' IDENTIFIED BY '${MAISON_CI_DB_PASSWORD}';"
docker exec maison_db_1 mysql -u root -p${MAISON_DB_ROOT_PASSWORD} -e "GRANT ALL PRIVILEGES ON ${MAISON_CI_DB_NAME}.* TO '${MAISON_CI_DB_USERNAME}'@'%';"
docker exec maison_db_1 mysql -u ${MAISON_CI_DB_USERNAME} -p${MAISON_CI_DB_PASSWORD} -D ${MAISON_CI_DB_NAME} -e ""

# Restart services that depend on the database.
./bin/restart
sleep 20

### Gitea.
# The administrative user.
docker exec maison_vcs_1 /app/gitea/gitea admin create-user --name ${MAISON_VCS_ADMIN_USERNAME} --password ${MAISON_VCS_ADMIN_PASSWORD} --email ${MAISON_VCS_ADMIN_EMAIL} --admin || true
# The CI (Drone) user.
docker exec maison_vcs_1 /app/gitea/gitea admin create-user --name ${MAISON_CI_GITEA_USERNAME} --password ${MAISON_CI_GITEA_PASSWORD} --email ${MAISON_CI_GITEA_EMAIL} --admin || true

### OLA
docker exec maison_ola_1 ola_patch -i -u 1 -d 1 -p 1
docker exec maison_ola_1 ola_patch -u 1 -d 2 -p 1
