version: '3.4'
services:
  consul:
    image: maison:consul
    build: ./services/consul
    restart: unless-stopped
    labels:
      maison.service.port: 8500
      maison.service.tags: 'maison-web,maison-web-auth,maison-service-check-http'
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
      - './data/services/consul:/consul/data'
    network_mode: host
    environment:
      MAISON_LOCAL_IP: '${MAISON_LOCAL_IP}'
      MAISON_CONSUL_MASTER_ACL_TOKEN_UUID: '${MAISON_CONSUL_MASTER_ACL_TOKEN_UUID}'
      MAISON_CONSUL_TEMPLATE_ACL_TOKEN_UUID: '${MAISON_CONSUL_TEMPLATE_ACL_TOKEN_UUID}'
  registrator:
    image: maison:registrator
    build: ./services/registrator
    restart: unless-stopped
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
    networks:
      - maison
    environment:
      MAISON_LOCAL_IP: '${MAISON_LOCAL_IP}'
      MAISON_CONSUL_MASTER_ACL_TOKEN_UUID: '${MAISON_CONSUL_MASTER_ACL_TOKEN_UUID}'
    depends_on:
      - consul
  syslog:
    image: jumanjiman/rsyslog:latest
    restart: always
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
    networks:
      maison:
        aliases:
          - syslog
    depends_on:
      - registrator
  db:
    image: 'mariadb:10.1'
    restart: always
    labels:
      maison.service.port: 3306
    ports:
     - '3306:3306'
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
      - './data/services/db:/var/lib/mysql'
      - './services/db/conf:/etc/mysql/conf.d'
    networks:
      maison:
        aliases:
          - db
    environment:
      MYSQL_ROOT_PASSWORD: '${MAISON_DB_ROOT_PASSWORD}'
    depends_on:
      - registrator
  auth:
    image: 'maison:auth'
    build: ./services/auth
    restart: always
    labels:
      maison.service.port: 8080
      maison.service.tags: 'maison-web,maison-service-check-http'
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
    networks:
      maison:
        aliases:
          - auth
    environment:
      DB_DATABASE: '${MAISON_AUTH_DB_NAME}'
      DB_USER: '${MAISON_AUTH_DB_USERNAME}'
      DB_PASSWORD: '${MAISON_AUTH_DB_PASSWORD}'
      KEYCLOAK_USER: '${MAISON_AUTH_ADMIN_USERNAME}'
      KEYCLOAK_PASSWORD: '${MAISON_AUTH_ADMIN_PASSWORD}'
      PROXY_ADDRESS_FORWARDING: 'true'
    depends_on:
      - registrator
      - db
  mailer:
    image: maison:mailer
    build: ./services/mailer
    restart: always
    labels:
      maison.service.port: 25
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
    networks:
      maison:
        aliases:
          - mailer
    environment:
      MAISON_MAILER_DOMAIN: '${MAISON_MAILER_DOMAIN}'
    depends_on:
      - registrator
  web:
    image: maison:web
    build: ./services/web
    restart: always
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
      - './data/services/web/letsencrypt:/etc/letsencrypt'
    expose:
     - '80'
     - '443'
    ports:
     - '80:80'
     - '443:443'
    networks:
      maison:
        aliases:
          - web
          # @todo How can we get rid of these explicitly defined aliases? Do we even need them?
          - 'auth.${MAISON_WEB_DOMAIN}'
          - 'oauth2.${MAISON_WEB_DOMAIN}'
    environment:
      MAISON_LOCAL_IP: '${MAISON_LOCAL_IP}'
      MAISON_WEB_PROTOCOL: '${MAISON_WEB_PROTOCOL}'
      MAISON_WEB_DOMAIN: '${MAISON_WEB_DOMAIN}'
      CONSUL_TOKEN: '${MAISON_CONSUL_TEMPLATE_ACL_TOKEN_UUID}'
    depends_on:
      - registrator
      - consul
  oauth2:
    image: maison:oauth2
    build: ./services/oauth2
    restart: always
    labels:
      maison.service.port: 4180
      maison.service.tags: 'maison-web'
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
    networks:
      maison:
        aliases:
          - oauth2
    environment:
      MAISON_WEB_DOMAIN: '${MAISON_WEB_DOMAIN}'
      MAISON_WEB_PROTOCOL: '${MAISON_WEB_PROTOCOL}'
      MAISON_OAUTH2_CLIENT_SECRET: '${MAISON_OAUTH2_CLIENT_SECRET}'
      MAISON_OAUTH2_COOKIE_SECRET: '${MAISON_OAUTH2_COOKIE_SECRET}'
    depends_on:
      - registrator
      - auth
  dns:
    image: maison:dns
    build: ./services/dns
    restart: always
    labels:
      maison.service.port: 5300
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
    ports:
     - '5300:53'
     - '5300:53/udp'
    networks:
      maison:
        aliases:
          - dns
    environment:
      MAISON_WEB_DOMAIN: '${MAISON_WEB_DOMAIN}'
      MAISON_LOCAL_IP: '${MAISON_LOCAL_IP}'
      CONSUL_TOKEN: '${MAISON_CONSUL_TEMPLATE_ACL_TOKEN_UUID}'
    depends_on:
      - registrator
networks:
  maison:
