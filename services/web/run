#!/usr/bin/env bash

set -Eeuo pipefail

# Parse ESH templates.
templates=(/etc/nginx/conf.d/*.conf*.esh)
for template in "${templates[@]}"; do
    esh -o "${template::-4}" "$template"
done

# Launch nginx.
nginx -g 'daemon on;'

# Obtain HTTPS certificates.
certbot_args="--nginx -n --agree-tos --email bart@mynameisbart.com"
for domain in ${MAISON_DOMAINS}; do
    certbot_args="$certbot_args -d $domain"
done
# If HTTPS is not enabled explicitly, use dry runs and allow failures, as those may be caused by non-public domains
# (*.local), which Let's Encrypt rejects.
if [ "$MAISON_WEB_PROTOCOL" == 'https' ]; then
    eval "certbot $certbot_args"
else
    eval "certbot certonly --dry-run $certbot_args" || true
fi;

# Launch Consul Template.
consul-template -consul-addr="$MAISON_LOCAL_IP:8500" \
    -template="/etc/nginx/conf.d/10-consul.conf.ctmpl:/etc/nginx/conf.d/10-consul.confz:nginx -s reload || true" \
    -log-level=debug
