#!/usr/bin/env bash

set -Eeuo pipefail

MAISON_HOST_IP=$(ip route show | awk '/default/ {print $3}')
export MAISON_HOST_IP

templates=(/etc/nginx/conf.d/*.conf*.esh)
for template in "${templates[@]}"; do
    esh -o "${template::-4}" "$template"
done

# Obtain HTTPS certificates.
nginx
certbot_args="--nginx -n --agree-tos --email bart@mynameisbart.com"
for service in ${MAISON_WEB_SERVICES}; do
    certbot_args="$certbot_args -d $service.$MAISON_WEB_DOMAIN"
done
# If HTTPS is not enabled explicitly, use dry runs and allow failures, as those may be caused by non-public domains
# (*.local), which Let's Encrypt rejects.
if [ "$MAISON_WEB_PROTOCOL" == 'https' ]; then
    eval "certbot $certbot_args"
else
    eval "certbot certonly --dry-run $certbot_args" || true
fi;
nginx -s quit

# Re-launch nginx in the foreground.
nginx -g 'daemon off;'
